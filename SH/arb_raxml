#!/bin/bash -x
# renames output to 'treefile'

usage() {
    arb_message "arb_raxml called with wrong parameters (look @ console for errors)"
    echo "Usage:"
    echo "   arb_raxml 'DNA'     SEQFILE WEIGHTS TREE RANDOMSTART OPTIMIZEPARAMETERS SEARCH INTERMEDIATETREES INITIALREARANGEMENT NUMBEROFRUNS TAKETREES MODELOFNUCSUB"
    echo "   arb_raxml 'PROTEIN' SEQFILE WEIGHTS TREE RANDOMSTART OPTIMIZEPARAMETERS SEARCH INTERMEDIATETREES INITIALREARANGEMENT NUMBEROFRUNS TAKETREES RATEMODEL MATRIXNAME"
    exit 1
}

if [ -z "$1" ]; then
    usage
else
    # parameters common for DNA and PROTEIN
    DATA=$1
    SEQFILE=$2
    WEIGHTS=$3
    TREE=$4
    RANDOMSTART=$5
    OPTIMIZEPARAMETERS=$6
    SEARCH=$7
    INTERMEDIATETREES=$8
    INITIALREARANGEMENT=$9

    shift 9

    NUMBEROFRUNS=$1
    TAKETREES=$2

    shift 2

    if [ "$DATA" == "DNA" ]; then
        if [ -z "$1" ]; then
            usage
        fi
        MODELOFNUCSUB=$1
    else
        if [ "$DATA" == "PROTEIN" ]; then
            if [ -z "$2" ]; then
                usage
            fi
            RATEMODEL=$1
            MATRIXNAME=$2
        else
            arb_message "Unknown datatype '$DATA'"
            exit 1
        fi
    fi

    # check inputfiles
    if [ \! -s $SEQFILE ]; then
        arb_message "Missing or empty sequence file '$SEQFILE'"
        exit 1
    fi
    if [ \! -s $WEIGHTS ]; then
        arb_message "Missing or empty weights file '$WEIGHTS'"
        exit 1
    fi

    # generate tree file
    TREEPARAMS=
    HAVEINPUTTREE=0
    if [ "$TREE" != "????" ]; then
        `arb_export_tree $TREE > treefile.in`
        if [ \! -s treefile.in ]; then
            arb_message "Couldn't export tree '$TREE'"
            exit 1
        fi
        TREEPARAMS="-t treefile.in"
        HAVEINPUTTREE=1
    else
        if [ "$RANDOMSTART" == "1" ]; then
            TREEPARAMS=-d
        fi
        # otherwise use default parsimony tree
    fi

    # OPTIMIZEPARAMETERS
    OPTIPARAMS=
    if [ "$OPTIMIZEPARAMETERS" == "1" ]; then
        if [ "$DATA" == "DNA" ]; then
            case "$MODELOFNUCSUB" in
                GTRMIX | GTRGAMMA )
                    OPTIPARAMS=-k
                    ;;
                * )
                    arb_message "Ignored 'Optimize branches/parameters'\n(only usable with GTRMIX or GTRGAMMA)"
                    ;;
            esac
        else
            case "$RATEMODEL" in
                "PROTMIX" | "PROTGAMMA" )
                    OPTIPARAMS=-k
                    ;;
                * )
                    arb_message "Ignored 'Optimize branches/parameters'\n(only usable with PROTMIX or PROTGAMMA)"
                    ;;
            esac
        fi
    fi

    # search algorithm

    NEEDINPUTTREE=0
    NEEDGAMMA=0

    case "$SEARCH" in
        "e" )
            NEEDINPUTTREE=1
            NEEDGAMMA=1
            ;;
        "p" | "t" )
            NEEDINPUTTREE=1
            ;;
    esac

    if [ "$NEEDINPUTTREE" != "$HAVEINPUTTREE" ]; then
        if [ "$NEEDINPUTTREE" == "1" ]; then
            arb_message "Please select an input tree"
            exit 1;
        else
            arb_message "Given input tree ignored"
        fi
    fi

    if [ "$NEEDGAMMA" == "1" ]; then
        if [ "$DATA" == "DNA" ]; then
            case "$MODELOFNUCSUB" in
                "GTRGAMMA" | "GTRGAMMAI" )
                    ;;
                * )
                    arb_message "Please choose GAMMA substitution model"
                    exit 1
                    ;;
            esac
        else
            case "$RATEMODEL" in
                "PROTGAMMA" | "PROTGAMMAI" )
                    ;;
                * )
                    arb_message "Please choose GAMMA rate model"
                    exit 1
                    ;;
            esac
        fi
    fi

    MODELPARAMS=
    if [ "$DATA" == "DNA" ]; then
        MODELPARAMS="-m $MODELOFNUCSUB"
    else
        MODELPARAMS="-m $RATEMODEL$MATRIXNAME"
    fi

    INTERMEDPARAMS=
    if [ "$INTERMEDIATETREES" == "1" ]; then
        INTERMEDPARAMS=-j
    fi

    # build parameters for raxml
    RAXMLPARAMS="$MODELPARAMS -f $SEARCH -i $INITIALREARANGEMENT -# $NUMBEROFRUNS -s $SEQFILE $TREEPARAMS $OPTIPARAMS $INTERMEDPARAMS -n ThisRun"

    echo "------------------------------------------"
    time raxmlHPC $RAXMLPARAMS
    echo "------------------------------------------"

    raxml2arb.pl ThisRun "$NUMBEROFRUNS" "$TAKETREES"

    # if [ -s RAxML_result.ThisRun ]; then
        # mv RAxML_result.ThisRun treefile
        
    # else
        # arb_message "No treefile (RAxML_result.ThisRun) generated by raxml (examine console for error)"
    # fi
fi
