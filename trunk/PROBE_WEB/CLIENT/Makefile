# Makefile for generation of jar archive from probe client classes

.SUFFIXES = .java .class .jar

BASE=$(ARBHOME)/PROBE_WEB/CLIENT
JAR=arb_probe_library.jar
TESTDIR=$(BASE)/testdir

ifeq ('$(MAIN)','CLIENT.a')
		TARGET=all
else
		TARGET=help_local
endif

main_target : $(TARGET)

help_local: help
		@echo "also built by 'make pc' in main ARB makefile"
		@echo ""

help:
	@echo "TARGET=$(TARGET)"
	@echo "MAIN=$(MAIN)"
	@echo ""
	@echo "    target      description"
	@echo "   ----------------------------------------------------------------------"
	@echo "    all         Build $(JAR)"
	@echo "    test        Run $(JAR) on DEBUG server"
	@echo "    test_master Run $(JAR) on Master server"
	@echo "    test_rs     Run $(JAR) on my local server (Ralf)"
	@echo "    clean       remove made files"
	@echo "    depends     update dependencies"
	@echo ""

JAVAS=$(wildcard *.java)
MANIFEST=mymanifest
CLASSES=$(JAVAS:.java=.class)
LINKCLASSES=*.class
BUILDLIST=.build.lst

# to speed up compilation this Makefile creates the file $(BUILDLIST)
# containing all .java files that need recompilation.

all:
	test \! -f $(BUILDLIST) || rm $(BUILDLIST)
	$(MAKE) $(JAR)

%.class : %.java
		@-((test -f $@ && rm $@) || true)
		@echo "$<" >>$(BUILDLIST)

compile:
		@echo javac `cat $(BUILDLIST)`
		@javac `cat $(BUILDLIST)`

$(JAR) : $(CLASSES) $(JAVAS) Makefile $(MANIFEST)
		test \! -f $(BUILDLIST) || ($(MAKE) compile && rm $(BUILDLIST))
		jar -cmf $(MANIFEST) $(JAR) $(LINKCLASSES)

rebuild: clean all

test: all
	(	mkdir -p $(TESTDIR)/debug ;\
	        cd $(TESTDIR)/debug ;\
		echo "----------------------------------------" ;\
		echo "OOOOOOOOOOOOPS - incorrect server address!!!" ;\
		java -jar $(BASE)/$(JAR) server=http://www2.mikro.biologie.tu-muenchen.de/probeserver24367472/ ;\
		echo "----------------------------------------" ;\
	        ls -al -rt )

test_master: all
	(	mkdir -p $(TESTDIR)/master ;\
		cd $(TESTDIR)/master ;\
		echo "----------------------------------------" ;\
		java -jar $(BASE)/$(JAR)  ;\
		echo "----------------------------------------" ;\
		ls -al -rt )

test_rs: all
	(	mkdir -p $(TESTDIR)/local ;\
		cd $(TESTDIR)/local ;\
		echo "----------------------------------------" ;\
		java -jar $(BASE)/$(JAR) server=http://hi.er/probeserver/ ;\
		echo "----------------------------------------" ;\
		ls -al -rt )

clean:
	@-rm		*.class \
			$(JAR) \
			.depends \

# dependencies

include .depends

.depends :
		$(ARBHOME)/SOURCE_TOOLS/make_java_dependencies.sh > .depends

depends:
		rm .depends
		$(MAKE) .depends


